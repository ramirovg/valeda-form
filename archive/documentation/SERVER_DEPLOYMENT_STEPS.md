# Valeda Form - Server Deployment Steps

**Target Server:** 104.248.69.154  
**Deployment Path:** /var/www/oftalmonet.mx/valeda/  
**Date:** 2025-08-25

## Prerequisites âœ…
- [x] Deployment files committed and pushed to GitHub
- [x] PM2 and MongoDB already running on server
- [x] SSH access to server configured

---

## Server Deployment Commands

### Step 1: Connect to Server
```bash
ssh root@104.248.69.154
```

### Step 2: Navigate to Web Directory
```bash
cd /var/www/oftalmonet.mx/
```

### Step 3: Backup Existing Directory (if exists)
```bash
if [ -d "valeda" ]; then mv valeda valeda-backup-$(date +%Y%m%d-%H%M%S); fi
```

### Step 4: Clone Repository
```bash
# Option 1: Public clone (no authentication required)
git clone https://github.com/ramirovg/valeda-form.git valeda

# If authentication is required, see GITHUB_AUTH_SETUP.md
cd valeda
```

### Step 5: Switch to Deployment Branch
```bash
git checkout deployment/production-setup
```

### Step 6: Setup Deployment Structure
```bash
cp deployment/server-production.js ./
cp deployment/ecosystem.config.js ./
cp deployment/package.json ./
cp deployment/.env.template ./
```

### Step 7: Copy Built Application Files
```bash
if [ -d "dist/valeda-form/browser" ]; then cp -r dist/valeda-form/browser ./; fi
if [ -d "dist/valeda-form/server" ]; then cp -r dist/valeda-form/server ./; fi
```

### Step 8: Set Proper Permissions
```bash
chown -R $USER:$USER /var/www/oftalmonet.mx/valeda
chmod +x server-production.js
```

### Step 9: Create Environment File
```bash
if [ ! -f .env ]; then cp .env.template .env; fi
```

### Step 10: Verify Directory Structure
```bash
ls -la
```

**Expected files:**
- server-production.js
- ecosystem.config.js
- package.json
- .env
- browser/ (directory)
- server/ (directory)

---

## Installation and Startup

### Step 11: Install Dependencies
```bash
npm install --production
```

### Step 12: Start Application with PM2
```bash
pm2 start ecosystem.config.js --env production
```

### Step 13: Verify PM2 Status
```bash
pm2 status
pm2 logs valeda-form-api
```

---

## Next Steps

After successful deployment:

1. **Configure Nginx Reverse Proxy** (see NGINX_CONFIGURATION.md)
2. **Test API endpoints**
3. **Test frontend at oftalmonet.mx/valeda/**
4. **Monitor logs and performance**

---

## Troubleshooting

### If npm install fails:
```bash
# Check Node.js version
node --version
npm --version

# Clear npm cache if needed
npm cache clean --force
```

### If PM2 start fails:
```bash
# Check PM2 status
pm2 status

# View logs
pm2 logs valeda-form-api

# Restart if needed
pm2 restart valeda-form-api
```

### If database connection fails:
```bash
# Check MongoDB status
systemctl status mongod

# Test MongoDB connection
mongo --eval "db.adminCommand('ismaster')"
```

---

## Environment Configuration

Edit `.env` file if you need to customize:

```bash
nano .env
```

**Key settings:**
- `MONGODB_URI=mongodb://localhost:27017/valeda-treatments-prod`
- `PORT=3001`
- `NODE_ENV=production`

---

## Commands Reference

**Check application status:**
```bash
pm2 status
pm2 logs valeda-form-api
```

**Restart application:**
```bash
pm2 restart valeda-form-api
```

**Stop application:**
```bash
pm2 stop valeda-form-api
```

**Update from repository:**
```bash
cd /var/www/oftalmonet.mx/valeda
git pull origin deployment/production-setup
pm2 restart valeda-form-api
```

---

*Generated by Claude Code on 2025-08-25*